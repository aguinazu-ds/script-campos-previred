name: Compilar Ejecutable Windows

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Permite ejecutar manualmente

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        
    - name: Compilar con PyInstaller
      run: |
        pyinstaller ^
          --onefile ^
          --console ^
          --name ProcesadorPrevired ^
          --add-data "archivos105espacios;archivos105espacios" ^
          --add-data "jornadas;jornadas" ^
          --distpath . ^
          --workpath build ^
          --specpath build ^
          procesar_archivos_windows.py
          
    - name: Verificar ejecutable
      run: |
        if (Test-Path "ProcesadorPrevired.exe") {
          Write-Host "‚úÖ Ejecutable creado exitosamente"
          $size = (Get-Item "ProcesadorPrevired.exe").Length
          Write-Host "üìä Tama√±o: $size bytes"
          
          # Mostrar informaci√≥n del ejecutable
          Write-Host "üìã Informaci√≥n del ejecutable:"
          Get-ItemProperty "ProcesadorPrevired.exe" | Select-Object Name, Length, LastWriteTime
        } else {
          Write-Host "‚ùå Error: Ejecutable no encontrado"
          Write-Host "üìÅ Contenido del directorio:"
          Get-ChildItem -Force
          exit 1
        }
        
    - name: Crear paquete de distribuci√≥n
      run: |
        # Crear carpeta de distribuci√≥n
        New-Item -ItemType Directory -Force -Path "ProcesadorPrevired_v1.0"
        
        # Copiar ejecutable
        Copy-Item "ProcesadorPrevired.exe" "ProcesadorPrevired_v1.0/"
        
        # Crear estructura de carpetas
        New-Item -ItemType Directory -Force -Path "ProcesadorPrevired_v1.0/archivos105espacios"
        New-Item -ItemType Directory -Force -Path "ProcesadorPrevired_v1.0/jornadas"
        
        # Copiar archivo de jornadas si existe
        if (Test-Path "jornadas/jornadasTrabajadores.csv") {
          Copy-Item "jornadas/jornadasTrabajadores.csv" "ProcesadorPrevired_v1.0/jornadas/"
        }
        
        # Crear archivo de instrucciones
        $instrucciones = @"
PROCESADOR DE ARCHIVOS PREVIRED - INSTRUCCIONES DE USO
=====================================================

REQUISITOS:
- Windows 10/11
- NO requiere Python instalado

PREPARACI√ìN:
1. Coloque sus archivos .txt o .TXT en la carpeta "archivos105espacios"
2. Verifique que el archivo "jornadas\jornadasTrabajadores.csv" contenga
   todos los RUTs de sus trabajadores con su jornada correspondiente

FORMATO DEL ARCHIVO DE JORNADAS:
- Archivo: jornadas\jornadasTrabajadores.csv
- Formato: rut;jornada
- Ejemplo:
  rut;jornada
  12345678-9;1
  98765432-1;2

VALORES DE JORNADA:
- 1 = Jornada completa
- 2 = Jornada parcial

USO:
1. Ejecute ProcesadorPrevired.exe
2. El programa procesar√° autom√°ticamente todos los archivos
3. Los resultados aparecer√°n en la carpeta "archivos_modificados"

IMPORTANTE:
- TODOS los RUTs en los archivos de datos deben estar en jornadasTrabajadores.csv
- Si falta alg√∫n RUT, el programa se detendr√° con un mensaje de error
- Los archivos originales NUNCA se modifican

ESTRUCTURA DE CARPETAS REQUERIDA:
ProcesadorPrevired_v1.0/
‚îú‚îÄ‚îÄ ProcesadorPrevired.exe           (ejecutable principal)
‚îú‚îÄ‚îÄ archivos105espacios/             (coloque aqu√≠ sus archivos .txt)
‚îú‚îÄ‚îÄ jornadas/                        (archivo de jornadas)
‚îÇ   ‚îî‚îÄ‚îÄ jornadasTrabajadores.csv
‚îú‚îÄ‚îÄ archivos_modificados/            (se crea autom√°ticamente)
‚îî‚îÄ‚îÄ INSTRUCCIONES.txt                (este archivo)

NOTAS T√âCNICAS:
- Compilado con PyInstaller para m√°xima compatibilidad
- Ejecutable standalone (no requiere instalaci√≥n)
- Compatible con Windows 10/11 (64-bit)

=====================================================
Procesador compilado con PyInstaller
Versi√≥n 1.0 - 2024
"@
        $instrucciones | Out-File -FilePath "ProcesadorPrevired_v1.0/INSTRUCCIONES.txt" -Encoding UTF8
        
        # Crear archivo de ejemplo
        $ejemplo = @"
Coloque aqu√≠ sus archivos .txt o .TXT

Los archivos deben tener el formato de ancho fijo
de Previred con 813 caracteres por l√≠nea.

Ejemplos de nombres v√°lidos:
- 077120142202508.TXT
- datos_previred.txt
- archivo_trabajadores.TXT
"@
        $ejemplo | Out-File -FilePath "ProcesadorPrevired_v1.0/archivos105espacios/COLOQUE_AQUI_SUS_ARCHIVOS.txt" -Encoding UTF8

    - name: Crear ZIP de distribuci√≥n
      run: |
        Compress-Archive -Path "ProcesadorPrevired_v1.0" -DestinationPath "ProcesadorPrevired_v1.0.zip"
        
    - name: Subir ejecutable como artefacto
      uses: actions/upload-artifact@v3
      with:
        name: ProcesadorPrevired-Windows
        path: |
          ProcesadorPrevired.exe
          ProcesadorPrevired_v1.0.zip
        retention-days: 90
        
    - name: Crear release si es tag
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ProcesadorPrevired.exe
          ProcesadorPrevired_v1.0.zip
        name: Procesador Previred ${{ github.ref_name }}
        body: |
          ## Procesador de Archivos Previred ${{ github.ref_name }}
          
          **Ejecutable Windows compilado con PyInstaller**
          
          ### Archivos incluidos:
          - `ProcesadorPrevired.exe` - Ejecutable standalone
          - `ProcesadorPrevired_v1.0.zip` - Paquete completo con carpetas e instrucciones
          
          ### Caracter√≠sticas:
          - ‚úÖ No requiere Python instalado
          - ‚úÖ Ejecutable nativo Windows
          - ‚úÖ Compilado con PyInstaller para m√°xima compatibilidad
          - ‚úÖ Procesamiento autom√°tico de archivos Previred
          - ‚úÖ Validaci√≥n estricta de RUTs
          - ‚úÖ Manejo de jornadas laborales
          - ‚úÖ Compatible con Windows 10/11
          
          ### Uso:
          1. Descargue `ProcesadorPrevired_v1.0.zip`
          2. Extraiga en su computadora
          3. Siga las instrucciones en `INSTRUCCIONES.txt`
          
          ### Notas t√©cnicas:
          - Tama√±o aproximado: 15-25 MB
          - Tiempo de compilaci√≥n: ~2-3 minutos
          - Tested en Windows 10/11
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
